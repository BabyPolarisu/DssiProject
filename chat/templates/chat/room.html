{% extends 'base.html' %}

{% block content %}
<div class="max-w-3xl mx-auto my-10 bg-white rounded-xl shadow-lg overflow-hidden flex flex-col h-[600px]">
    
    <div class="bg-blue-600 p-4 flex items-center justify-between text-white">
        <div>
            <h2 class="font-bold text-lg">
                {% if request.user == room.buyer %}
                    ‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢: {{ room.seller.username }}
                {% else %}
                    ‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠: {{ room.buyer.username }}
                {% endif %}
            </h2>
            <p class="text-sm text-blue-100">‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: {{ room.product.name }}</p>
        </div>
        <a href="{% url 'product_detail' room.product.id %}" class="text-sm bg-blue-500 hover:bg-blue-400 px-3 py-1 rounded">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏î‡∏π‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a>
    </div>

    <div id="chat-log" class="flex-1 p-4 overflow-y-auto bg-gray-50 space-y-4">
        {% for message in messages %}
            <div class="flex {% if message.sender == request.user %}justify-end{% else %}justify-start{% endif %}">
                <div class="max-w-[70%] px-4 py-2 rounded-lg {% if message.sender == request.user %}bg-blue-500 text-white{% else %}bg-gray-200 text-gray-800{% endif %}">
                    {{ message.content }}
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="p-4 bg-white border-t border-gray-200">
        <div class="flex gap-2">
            <input id="chat-message-input" type="text" class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...">
            <button id="chat-message-submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-bold">‡∏™‡πà‡∏á</button>
        </div>
        <div class="mt-2 flex gap-2 overflow-x-auto pb-2">
            <button onclick="sendQuickMessage('üìç ‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÇ‡∏£‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡∏•‡∏≤‡∏á')" class="text-xs bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-full border">üìç ‡πÇ‡∏£‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡∏•‡∏≤‡∏á</button>
            <button onclick="sendQuickMessage('üìç ‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏∂‡∏Å‡∏Ñ‡∏ì‡∏∞')" class="text-xs bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-full border">üìç ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏∂‡∏Å‡∏Ñ‡∏ì‡∏∞</button>
            <button onclick="sendQuickMessage('üì¶ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?')" class="text-xs bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-full border">üì¶ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°?</button>
        </div>
    </div>
</div>

<script>
    const roomId = {{ room.id }};
    const userId = {{ request.user.id }};

    const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
    
    // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WebSocket
    const chatSocket = new WebSocket(
        ws_scheme + '://' + window.location.host + '/ws/chat/' + roomId + '/'
    );

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const chatLog = document.querySelector('#chat-log');
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà
        const isMe = data.sender_id === userId;
        const msgHtml = `
            <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                <div class="max-w-[70%] px-4 py-2 rounded-lg ${isMe ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800'}">
                    ${data.message}
                </div>
            </div>
        `;
        
        chatLog.insertAdjacentHTML('beforeend', msgHtml);
        chatLog.scrollTop = chatLog.scrollHeight; // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    // ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.keyCode === 13) {  // enter key
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        
        if(message.trim() !== "") {
            chatSocket.send(JSON.stringify({
                'message': message,
                'sender_id': userId
            }));
            messageInputDom.value = '';
        }
    };

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö
    function sendQuickMessage(msg) {
        chatSocket.send(JSON.stringify({
            'message': msg,
            'sender_id': userId
        }));
    }
</script>
{% endblock %}